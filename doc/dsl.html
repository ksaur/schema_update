<html>
<title> NoSQL Implicit Schema Update</title>
<h1>NoSQL DSL v2.0</h1>
<h2>Questions</h2>

<li> Too many <code>for</code>'s in multiple json change?

<br>
<HR COLOR="DarkOliveGreen" SIZE=6>
<br>
<h1> DSL Commands</h1>
<b><u>The basic format for the DSL:</u></b><br><br>
<i>For existing keys:</i><br><br>
<code>
&nbsp;&nbsp;<b>for [</b>redis keyglob<b>, </b>JSON path separated by commas (if any)<b>]{</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;CMD (directive (the path, if INIT)<b> {</b>code<b>}</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;(more commands if necessary)<br>
&nbsp;&nbsp;<b>};</b><br>
</code>
<br>
<i>For new keys:</i><br><br>
<code>
&nbsp;&nbsp;<b>INIT </b>limited redis keyglob (no '*' or '?')<b>, </b>JSON path separated by commas (if any)<b> {</b>code<b>};</b><br>
</code>
<font color=red>TODO Are <code>[]</code> OK here when <code>INIT</code> isn't inside <code>for</code> and has a path list (Ex: <code>INIT [n[1-3], foo, bar]</code>?   If not, should we also remove <code>[]</code> on <code>for</code> above?</font>
<br>
<br>
<b><u>There are 3 directive commands that can be used:</u></b>
<br>
<br>
<table border=1>
<tr><td><b>Directive </td></b><td><b>	Contents </td></b><td><b>	Must Return </td></b><td><b>Where Used</b></td></tr>
<tr><td>INIT</td><td> 	limited key glob (ranges but no '*' or '?') {$out= ..code..} 	</td><td>None</td><td>both inside <code>for</code> and stand-alone for non-existing keys </td></tr>
<tr><td>DEL </td><td>	 {..code to determine what to delete.. return True/False..}	</td><td>Bool</td><td>inside <code>for</code></td></tr>
<tr><td>UPD </td><td>	 {$out = ..code..}	</td><td>None</td><td>inside <code>for</code></td></tr>
</table>

<ul>
   <li> The "directive" column is the action to be performed: initializing a new field, deleting a field, or updating the value contained in a field.
   <li> For <code>INIT</code>, the "contents" column includes a keyglob, which may contain ranges but no wildcards.
   <li> The <code>DEL</code> command must return a boolean indicating whether or not to delete the item.
</ul>
<b><u>In addition to the directive commands above, there are some tokens that automatically expand to generated code:</u></b>

<br>
<br>
<table border=1>
<tr><b><td><b>Directive </td></b><td><b>	Meaning</td></b></b></tr>
<tr><td>$out </td><td>	the value they key will be set to</td></tr>
<tr><td>$in <font color=red>TODO: remove??</font> </td><td>  the original value of the key</td></tr>
<tr><td>$base</td><td> 	the same JSON structure, used to address siblings</td></tr>
<tr><td>$root</td><td> 	the root of the JSON structure.</td></tr>
<tr><td>$dbkey</td><td> the data basekey currently being processed</td></tr>
<tr><td>$inkey</td><td> the key <i>list</i> provided in the <code>for</code> or <code>INIT</code> clause</td></tr>
<tr><td>$outkey</td><td> the key <i>list</i>, to be written to</td></tr>
</table>

<br>
<br>


<br>
<HR COLOR="DarkOliveGreen" SIZE=6>
<h2>============ Changing JSON Values ===========</h2>
<br>
<h2> JSON Value Change Example 1: <i>INIT, REN, UPD, DEL</i></h2>

<h4>JSON Value:</h4>
<code>

{<br>
&nbsp;&nbsp;    "_id": "4bd8ae97c47016442af4a580", <font color = blue># convert this to decimal</font><br>
&nbsp;&nbsp;    "customerid": 99999,<br>
&nbsp;&nbsp;    "name": "Foo Sushi Inc",<br>
&nbsp;&nbsp;    "since": "12/12/2001",<br>
&nbsp;&nbsp;    "category": "A",<font color = blue> # delete this field</font><br>
&nbsp;&nbsp;    "order": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        "orderid": "UXWE-122012",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        "orderdate": "12/12/2001",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        "orderItems": [<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                "product": "Fortune Cookies",<br> 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                "price": 19.99 <font color = blue> #rename this to "fullprice"</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                <font color = blue># insert a "discountedPrice" field here for some % off "fullprice"</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       ]<br>
&nbsp;&nbsp;    }<br>
}<br>
</code>
<h4>DSL:</h4>
<code>
for  [*, "order", ["orderItems"]] { <font color=blue># "orderItems" is itself a list</font><br>
 &nbsp;&nbsp; INIT "discountedPrice" {$out = round($base['price']*.7,2)}<br>
};<br>
<br>
<font color=blue># doing a rename of price &rarr; fullprice</font><br>
for  [*, "order", ["orderItems"], "price"] {<br>
 &nbsp;&nbsp; UPD {$outkey = [$dbkey, "order", ["orderItems"], "fullprice"] }  <br>
};<br>
for  [*, "_id"] {<br>
 &nbsp;&nbsp; UPD {if any(c.isalpha() for c in $in):<br>
 &nbsp;&nbsp;&nbsp;&nbsp;           $out=int($in, 16)}<br>
};<br>
for  [*, "category"] {<br>
 &nbsp;&nbsp; DEL {return True}<br>
};<br>
</code>


<!--<code>
for keys * {<br>
&nbsp;&nbsp;INIT ["order", ["orderItems"], "discountedPrice"]: {<b>$out</b> = round(<b>$base</b>['price']*.7,2)}<br>
&nbsp;&nbsp;REN ["order", ["orderItems"], "price"]->["order", ["orderItems"], "fullprice"]<br>
&nbsp;&nbsp;UPD ["_id"]: {<br>
&nbsp;&nbsp;if any(c.isalpha() for c in <b>$in</b>): <a name="in"></a><br>
&nbsp;&nbsp;    <b>$out</b>=int(<b>$in</b>, 16)} <font color = green> # could actually just use <b>$out</b> here (because <b>$out=$in</b> and <b>out</b> not overwritten)</font><br>
&nbsp;&nbsp;DEL ["category"]<br>
};<br>
</code>
<h2> JSON Value Change Example 2: <i>$root, $base, $out, $in</i></h2>
<h4>JSON Value:</h4>
<code>
{<br>
 &nbsp;&nbsp;   "name": "Foo Bar Industries",<br>
 &nbsp;&nbsp;   "orderdate": "12/12/2014",<br>
 &nbsp;&nbsp;   "order": {<br>
  &nbsp;&nbsp;&nbsp;&nbsp;      "orderid": "UUUXXXX",<font color=blue> #append "orderdate" to this.  </font><br>
 &nbsp;&nbsp;&nbsp;&nbsp;       "orderitems": [<br>
 &nbsp;&nbsp;&nbsp;&nbsp;           {<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;               "product": "Foo Bar Ball",<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;               "percentfullprice": 0.7, <font color=blue>#increase this back to 1.0</font><br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;               "price": 13.99 <font color=blue>#set this back to full price (calculated from percentfullprice)</font><br>
 &nbsp;&nbsp;&nbsp;&nbsp;          }<br>
   &nbsp;&nbsp;&nbsp;&nbsp;     ]<br>
   &nbsp;&nbsp; }<br>
}<br>
</code>
<h4>DSL:</h4>
<code>
for keys * {<br>
&nbsp;&nbsp;UPD ["order", ["orderitems"], "percentfullprice"]: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<b>$out</b> = 1.0<br>
<font color=green>
&nbsp;&nbsp;&nbsp;&nbsp;# demonstrate usage of <b>$in</b>...the previous line clobbers <b>$out</b> <br>
&nbsp;&nbsp;&nbsp;&nbsp;# (which is the same as clobbering <b>$in</b>.  Although...we could switch these two lines and use just <b>$out</b>)<br>
</font>
&nbsp;&nbsp;&nbsp;&nbsp;<b>$base</b>['price'] = round(<b>$base</b>["price"]/<b>$in</b>,2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;print <b>$base</b>["price"]<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;UPD ["order", "orderid"]: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;# demonstrate $root<br>
&nbsp;&nbsp;&nbsp;&nbsp;<b>$out</b>= <b>$out</b> + "_" + <b>$root</b>.get("orderdate").replace("/","")<br>
&nbsp;&nbsp;}<br>
};
</code>
<h2> JSON Value Change Example 3: <i>$dbkey</i></h2>
<b>Key Format:</b><br>  
<code>&nbsp;&nbsp; edgeattr_n4@n5</code>, where <code>n4</code> and <code>n5</code> are names of the node<br><br>
<b>JSON Value:</b><br>
<code>
{<br>
 &nbsp;&nbsp;  "outport": 2,<br>
 &nbsp;&nbsp;  "inport": 3<br>
 &nbsp;&nbsp;<font color=blue> #add a backpointer edge called "reverseid" here</font><br> 
}<br>
</code>
<h4>DSL:</h4>
<code>
for keys * {
&nbsp;&nbsp;INIT "reverseid": {<br>
&nbsp;&nbsp;edge = <b>$dbkey</b>.split("@")  <br>
&nbsp;&nbsp;&nbsp;&nbsp;in_node = str(edge[0]).replace("edgeattr_", "")<br>
&nbsp;&nbsp;&nbsp;&nbsp;out_node = str(edge[1])  <br>
&nbsp;&nbsp;&nbsp;&nbsp;<b>$out</b> = out_node + "@" + in_node<br>
&nbsp;&nbsp;}<br>
};
</code>

-->
<br>
<br>
<HR COLOR="DarkOliveGreen" SIZE=6>

<h2>============ Changing KEYS ===========</h2>

<br>

<h2> Key Change Example 1: <i>INIT</i></h2>
<p>
For <code>INIT</code>, only bounded <a href="http://redis.io/commands/KEYS">key-globs</a> (ranges, but no wildcards such as <code>?</code> or <code>*</code>) are allowed.<br><br>
</p>
<b>Key Format:</b><br>  
<code>&nbsp;&nbsp; edgeattr_n4@n5</code>, where <code>n4</code> and <code>n5</code> are names of the nodes that form a "from@to" directed edge. These entries store the attributes for the edge.<br><br>

<b>DSL:</b><br>
Say we want to initialize (add new entries to redis for) a set of edges from node <i>n4&rarr;{n1,n2,n3,n5}</i> and from node <i>n5&rarr;{n1,n2,n3}</i>.
<br>
<br>
<code>
INIT edgeattr_n4@n[1-3,5] {$out = {"outport": None, "inport": None}};<br>
INIT edgeattr_n5@n[1-3]  {$out = {"outport": None, "inport": None}};<br>
</code>

<br>
<h2> Key Change Example 2: <i>DEL</i></h2>
<b>Key Format:</b><br>  
<code>&nbsp;&nbsp; edgeattr_n4@n5</code>, where <code>n4</code> and <code>n5</code> are names of the nodes that form a "from@to" directed edge. These entries store the attributes for the edge.<br><br>
<b>DSL:</b><br>
Say we want to delete all edges that are from or to nodes with names greater than <code>n4</code>.  
<br>
<br>
<pre>
for [edgeattr_n*@n*] { 
  DEL {nodes = $dbkey.split("_")[1].split("@")
  if (nodes[0]>"n4" or nodes[1]>"n4")
    return True
  else
    return False 
  }
};
</pre>
<br>
<h2> Key Change Example 3: <i>UPD</i></h2>
<b>Key Format:</b><br>  
<code>&nbsp;&nbsp; edgeattr_n4@n5</code>, where <code>n4</code> and <code>n5</code> are names of the nodes that form a "from@to" directed edge. These entries store the attributes for the edge.<br><br>
<b>DSL:</b><br>
Say we want to add a namespace "graph1" onto the keyname, such as "<code>edgeattr_n4@n5</code>" &rarr; "<code>edgeattr_n4@n5_graph1</code>"
<br>
<br>
<pre>
for [edgeattr*] {
  UPD {$outkey = $outkey+"_graph"}
};
</pre>

<br>
<br>
</html>
